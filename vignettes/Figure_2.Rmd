---
title: "Figure 2: Model fit of COVID-19 incidence across European countries."
author: "Hugo Gruson"
date: "`r Sys.Date()`"
output: rmarkdown::html_document
---

```{r}
suppressPackageStartupMessages({
  library(dplyr)
  library(ggplot2)
  library(purrr)
})
```

Despite large variability in terms of public health responses and sociocultural backgrounds across Europe, we were able to accurately quantify viral transmission rates over time in each country before and after implementation of public health responses, reproducing the observed national epidemiological dynamics.

```{r}
library(NpiEurope)
npi_europe <- load_npi_data()
epi_europe <- load_epi_data()
```

```{r}
simulate_from_MCMC <- function(file, npi_europe, epi_europe) {
  
  country <- gsub(".*/((\\w|\\s)+)\\.csv$", "\\1", file)
  
  npi_country <- npi_europe %>%
    filter(Country == country) %>%
    select(-Country)
  
  epi_country <- epi_europe %>%
    filter(Country == country) %>%
    select(-Country) %>%
    transmute(
      date = Date,
      new_cases = NewCases,
      new_deaths = NewDeaths
    ) %>%
    mutate(new_cases = pmax(new_cases, 0),
           new_deaths = pmax(new_deaths, 0)) %>%
    merge(asymptor::estimate_asympto(., bounds = "lower")) %>%
    transmute(
      Date = date,
      NewCases = new_cases,
      PropAsympto = lower / (lower+new_cases)
    ) %>%
    mutate(PropAsympto = ifelse(is.finite(PropAsympto), PropAsympto, 0)) %>%
    mutate(PropAsympto = slider::slide_dbl(PropAsympto, mean, .before = 3, .after = 3, .complete = FALSE))

  contact_country <- load_contact_data(country)
  age_country <- sirage::load_age_data(country)

  sims <- sirage::simulate_trajectory(
    file,
    epi_country, npi_country, contact_country, age_country,
    Npost = 10
  )
  
  sims <- as.data.frame(do.call(rbind, sims))
  sims$Date <- as.Date(intersect(npi_country$Date, epi_country$Date), origin = "1970-01-01")
  sims$Country <- country
  
  sims <- merge(sims, epi_country)
  
  return(sims)
  
}
```

```{r, fig.height=15, fig.cap='Each panel shows model predictions (black shaded area) and confirmed number of new COVID-19 cases over time for each country.'}
list.files("../MCMC_NpiEurope", pattern = "\\.csv$", full.names = TRUE) %>%
  map_dfr(simulate_from_MCMC, npi_europe, epi_europe) %>%
  rowwise() %>%
  mutate(sims_low = quantile(c_across(V1:V20), probs = 0.05),
         sims_high = quantile(c_across(V1:V20), probs = 0.95),
         .keep = "unused") %>%
  ggplot(aes(x = Date)) +
    geom_ribbon(aes(ymin = sims_low, ymax = sims_high)) +
    geom_line(aes(y = NewCases), col = "red") +
    facet_wrap(~ Country, scales = "free_y", ncol = 3)
```
# Reproducibility information

File created on `r Sys.Date()` with the following session details:

<details>
<summary>Session info</summary>

```{r}
sessionInfo()
```

</details>
