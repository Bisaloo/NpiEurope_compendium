---
title: "ESM: report rate and efficiencies for each country"
author: "Hugo Gruson"
date: "`r Sys.Date()`"
output: rmarkdown::html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  class.warning = "collapsable-warnings",
  message = FALSE
)
```

```{r}
library(dplyr)
library(ggplot2)
```

```{r}
library(NpiEurope)
epi_europe <- load_epi_data()
npi_europe <- load_npi_data()
```

# Report rates

We estimated daily non-reported cases for each country using the daily new 
reported cases and daily new deaths and the capture/recapture methodology
described by 
[BÃ¶hning *et al.* (2020)](https://doi.org/10.1016%2Fj.ijid.2020.06.009),
implemented in the [asymptor](https://cran.r-project.org/package=asymptor)
package.

```{r, fig.height=15}
library(asymptor)

epi_europe %>%
  transmute(
    date = as.Date(Date), 
    new_cases = NewCases, 
    new_deaths = NewDeaths,
    country = Country
  ) %>%
  group_by(country) %>%
  mutate(new_cases = pmax(new_cases, 0),
         new_deaths = pmax(new_deaths, 0)) %>%
  mutate(new_cases = slider::slide_dbl(new_cases, mean, .before = 3, .after = 3),
         new_deaths = slider::slide_dbl(new_deaths, mean, .before = 3, .after = 3)) %>%
  summarise(estimate_asympto(cur_data()),
            detected = new_cases) %>%
  ggplot(aes(x = date)) +
    geom_ribbon(aes(ymin = detected + lower, ymax = detected + upper)) +
    geom_line(aes(y = detected), color = "red") +
    facet_wrap(~ country, scales = "free_y", ncol = 3)
```

# Efficiency of each public health responses

We estimated transmission rates per country over time through Bayesian inference
by running a particle Monte Carlo Markov Chain (pMCMC) with the epidemiological
model described earlier. The chains had 10,000 iterations with a burn-in of 90%
and a thinning of 1/10. The likelihood was computed with a particle filter of
100 particles and a negative binomial function of parameter 0.5 on the total
daily number of new cases expected by the model and observed in the data (i.e.,
number of cases notified to the national public health system and number of
undetected cases estimated by the capture/recapture method). The ratio between
transmission rates with and without implementation of the PHR evaluated provides
an estimation of the efficiency of this response, therefore assuming that it had
an instantaneous effect.

```{r, results='asis'}
devnull <- list.files("../MCMC_NpiEurope/", "\\.csv$", full.names = TRUE) %>%
  lapply(function(f) {
      country <- gsub(".*/((\\w|\\s)+)\\.csv$", "\\1", f)

      npi_country <- npi_europe %>%
        filter(Country == country) %>%
        select(-Country)
    
      contact_country <- load_contact_data(country)
      age_country <- sirage::load_age_data(country)
    
      res <- summarise_estimation(f, npi_country, contact_country, age_country)
      
      cat("### ", country, "\n\n")
      print(knitr::kable(res))
  })
```

```{r, child='_sessionInfo.Rmd'}
```

```{js, echo=FALSE}
(function() {
  var codes = document.querySelectorAll('.collapsable-warnings');
  var code, i, d, s, p;
  for (i = 0; i < codes.length; i++) {
    code = codes[i];
    p = code.parentNode;
    d = document.createElement('details');
    s = document.createElement('summary');
    s.innerText = 'Warnings';
    // <details><summary>Details</summary></details>
    d.appendChild(s);
    // move the code into <details>
    p.replaceChild(d, code);
    d.appendChild(code);
  }
})();
```

